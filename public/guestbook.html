<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guestbook</title>
  <link href="style.css" rel="stylesheet">
</head>
<body>

<h1>
  Guestbook!!
  <a href="https://mraw.neocities.org" style="color: #ef931b;">Return</a>
</h1>

<form id="form">
  <input type="text" id="name" placeholder="Your name (optional)">
  <textarea id="message" required placeholder="Write a message"></textarea>
  <button type="submit">Submit</button>
</form>

<h2>Messages</h2>
<div id="messages"></div>

<script>
const API = "/api/messages";

const form = document.getElementById("form");
const messagesDiv = document.getElementById("messages");

// Prevent XSS
function escapeHTML(str) {
  if (!str) return "";
  return str.replace(/[&<>"']/g, tag => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[tag]));
}

// Load messages
async function loadMessages() {
  try {
    const res = await fetch(API);

    if (!res.ok) {
      messagesDiv.innerHTML = "<p>Failed to load messages.</p>";
      return;
    }

    const data = await res.json();

    messagesDiv.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      messagesDiv.innerHTML = "<p>No messages yet.</p>";
      return;
    }

    data.forEach(msg => {
      const div = document.createElement("div");
      div.className = "message-box";

      div.innerHTML = `
        <strong>${escapeHTML(msg.name || "Anonymous")}</strong>
        <small>${msg.date ? new Date(msg.date).toLocaleString() : ""}</small>
        <p>${escapeHTML(msg.message)}</p>
      `;

      messagesDiv.appendChild(div);
    });

  } catch (err) {
    messagesDiv.innerHTML = "<p>Network error loading messages.</p>";
  }
}

// Submit form
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value || "Anonymous";
  const message = document.getElementById("message").value.trim();

  if (!message) {
    alert("Message cannot be empty.");
    return;
  }

  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, message })
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      alert(errorData.error || "Failed to submit message.");
      return;
    }

    form.reset();
    await loadMessages();

  } catch (err) {
    alert("Network error while submitting.");
  }
});

// Initial load
loadMessages();
</script>

</body>
</html>
